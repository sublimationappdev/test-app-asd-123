(function(){"use strict";const S=t=>{const i=t*180/Math.PI;return parseFloat(i.toFixed(1))},H=t=>t*Math.PI/180,$=t=>{const{top_diameter:i,bottom_diameter:e,height:o,gap_angle:d}=t,n=i,a=e,g=o,s=Math.sqrt(Math.pow(n,2)/4+Math.pow(n*g/(n-a),2)),h=Math.sqrt(Math.pow(a,2)/4+Math.pow(a*g/(n-a),2)),P=Math.PI*n/s,x=P*180/Math.PI,E=d/360*x,K=H(E);return{R:s,r:h,fi_rad:P,gap_rad:K}},Z=t=>{const{R:i,r:e,fi_rad:o,gap_rad:d}=$(t),n=o-d,a=i*Math.sin(n/2)*2,g=i-e*Math.cos(n/2);return{width:a,height:g}};function A(t){return"side"in t}function C(t){return"width"in t&&"height"in t&&!("border_radius"in t)&&!("border_radius_tl"in t)&&!("path"in t)}function T(t){return"width"in t&&"height"in t&&"border_radius"in t}function L(t){return"width"in t&&"height"in t&&("border_radius_tl"in t&&"border_radius_tr"in t&&"border_radius_bl"in t&&"border_radius_br"in t||"border_radius"in t)}function B(t){return"radius"in t}function D(t){return"top_radius"in t&&"bottom_radius"in t}function F(t){return"vertical_axis"in t&&"horizontal_axis"in t}function I(t){return"width"in t&&"height"in t&&"path"in t}const G=t=>{let i={width:0,height:0};if(A(t)){const{side:e}=t;({...t},i={width:e,height:e})}if(C(t)){const{width:e,height:o}=t;i={width:e,height:o},{...t}}if(T(t)){const{width:e,height:o}=t;i={width:e,height:o},{...t}}if(L(t)){const{width:e,height:o}=t;i={width:e,height:o},{...t}}if(B(t)){const{radius:e}=t;i={width:2*e,height:2*e},{...t}}if(D(t)){const{top_radius:e,bottom_radius:o,height:d,gap_angle:n}=t,a={top_diameter:e,bottom_diameter:o,height:d,gap_angle:S(n)};i=Z(a),{...t}}if(F(t)){const{horizontal_axis:e,vertical_axis:o}=t;i={width:e,height:o},{...t}}if(I(t)){const{width:e,height:o}=t;i={width:e,height:o},{...t}}return i},J=t=>{let i=null;if(i=A(t)?"square":C(t)?"rect":T(t)?"round-corners":L(t)?"round-corners-2":B(t)?"circle":D(t)?"cone":F(t)?"ellipse":I(t)?"path":null,i===null)throw new Error("Invalid printareaprops value");return i};let R=null,k=null,U=null,f=null,q;const Q=(t,i,e,o,d,n,a,g,s,h,P,x,E,K,c)=>new Promise((V,_)=>{if(console.log("[PrintViewWidget.WORKER1] generatePrintPage2 called",{printAreaProps:i,borders:e,pageProps:d,units:o,margin:h,offset:s,imageProps:a}),c&&c.aborted)return console.log("[PrintViewWidget.WORKER1] generatePrintPage aborted"),_(null);const r=()=>{console.log("[PrintViewWidget.WORKER1] generatePrintPage.onAbort called"),cancelAnimationFrame(q),_(null)};c&&c.addEventListener("abort",r);const W=d[o],z=G(i);console.log("[PrintViewWidget.WORKER1.generatePrintPage] borders",e);const l=n==="portrait"?W.width:W.height,b=n==="portrait"?W.height:W.width,p=a.width/z.width,u=o==="mm"?p:p/25.4,m=o==="in"?p:p*25.4,O={width:l,height:b},M=o==="mm"?u:m,w={width:O.width*M,height:O.height*M};w.width=Number(w.width.toFixed(0)),w.height=Number(w.height.toFixed(0));const N={width:O.width-(e.left+e.right),height:O.height-(e.top+e.bottom)},y={width:N.width*(o==="mm"?u:m),height:N.height*(o==="mm"?u:m)};if(y.width=Number(y.width.toFixed(0)),y.height=Number(y.height.toFixed(0)),t===null)return;t.canvas.width=w.width,t.canvas.height=w.height,console.log("[PrintViewWidget.WORKER1.generatePrintPage]  generatePrintPage",{page_print_size:O,page_print_size_px:w}),console.log("[PrintViewWidget.WORKER1.generatePrintPage]  dpm,dpi",{_dp:p,dpm:u,dpi:m});const X=o==="mm"?u*e.left:m*e.left,Y=o==="mm"?u*e.top:m*e.top,j=o==="mm"?u*e.bottom:m*e.bottom,tt=o==="mm"?u*e.right:m*e.right,v={left:X,right:tt,top:Y,bottom:j};console.log("[PrintViewWidget.WORKER1.generatePrintPage]  borders_px",v),t.save(),t.fillStyle="rgba(243, 20, 20, 0.5)",t.fillRect(0,0,w.width,w.height),t.fillStyle="rgb(252, 225, 175)",t.clearRect(v.left,v.top,w.width-(v.left+v.right),w.height-(v.top+v.bottom)),t.restore(),J(i),z.width+s.left+s.right+h.left+h.right,z.height+s.top+s.bottom+h.top+h.bottom,V(!0)});self.onmessage=function(t){const i=t.data;switch(console.log("[PrintViewWidget.WORKER1] event received",t.data.type,t),postMessage({action:"worker-msg-callback",data:t.data.type,filename:"canvas-image.png"}),i.type){case"initCanvas":const e=i.canvas;e&&(R=e.getContext("2d"),i.bitmap&&i.bitmapRotated&&(console.log("[PrintViewWidget.WORKER1] bitmap received",t.data.type,i.bitmap,i.bitmapRotated),k=i.bitmap,U=i.bitmapRotated));break;case"drawPrintPage":try{f.abort()}catch{}f=new AbortController;const{displayProps:o}=t.data;if(o!==void 0){const{borders:d,units:n,pageProps:a,orientation:g,imageProps:s,separator:h,copies:P,ruler:x,printItemProps:E}=o,K={top:0,left:0,bottom:0,right:0},c=h.margins;if(R!==null){const V=new Date().getTime();q=requestAnimationFrame(()=>Q(R,E,d,n,a,g,s,h,K,c,P,x,k,U,f.signal).then(r=>console.log("[PrintViewWidget.WORKER1] generatePrintPage2 finished",r,`time took ${new Date().getTime()-V}ms`)).catch(r=>console.log("[PrintViewWidget.WORKER1] generatePrintPage2 exceptin cougth",r,`time took ${new Date().getTime()-V}ms`)))}}break;case"savePrintPage":if(R!==null){const d=i.payload,{borders:n,units:a,dpi:g,page_size:s}=d,h=g/25.4,P=a==="mm"?h*n.left:g*n.left,x=a==="mm"?h*n.top:g*n.top,E=a==="mm"?h*n.bottom:g*n.bottom,K=a==="mm"?h*n.right:g*n.right,c={left:P,right:K,top:x,bottom:E},V=!Object.values(n).some(l=>l!==0),_=new Date().getTime();let r=_;const{width:W,height:z}=R.canvas;if(V)console.log("[PrintViewWidget.WORKER1]   starting convertToBlob",r-_),R.canvas.convertToBlob({type:"image/png"}).then(l=>{r=new Date().getTime(),console.log("[PrintViewWidget.WORKER1] convertToBlob  finished, starting createObjectURL",r-_);const b=URL.createObjectURL(l);r=new Date().getTime(),console.log("[PrintViewWidget.WORKER1] createObjectURL  finished, starting postMessage",r-_);const p={url:b,size:{width:s.width,height:s.height},size_px:{width:W,height:z},units:a};postMessage({type:"export-canvas-png",res:p})}).catch(l=>{console.error("[PrintViewWidget.WORKER1] Error converting canvas to blob:",l)});else{const l=W-(c.left+c.right),b=z-(c.top+c.bottom),p=new OffscreenCanvas(l,b);p.getContext("2d").drawImage(R.canvas,c.left,c.top,l,b,0,0,l,b),console.log("[PrintViewWidget.WORKER1]   starting convertToBlob",r-_),p.convertToBlob({type:"image/png"}).then(m=>{r=new Date().getTime(),console.log("[PrintViewWidget.WORKER1] convertToBlob  finished, starting createObjectURL",r-_);const O=URL.createObjectURL(m);r=new Date().getTime(),console.log("[PrintViewWidget.WORKER1] createObjectURL  finished, starting postMessage",r-_);const M={url:O,size:{width:s.width-(n.right+n.left),height:s.height-(n.top+n.bottom)},size_px:{width:l,height:b},units:a};postMessage({type:"export-canvas-png",res:M})}).catch(m=>{console.error("[PrintViewWidget.WORKER1] Error converting canvas to blob:",m)})}}break;case"drawBitmap":f&&(console.log("[PrintViewWidget.WORKER1] abortcontroller exists, refreshing",f.signal),f.abort(),f=new AbortController),t.data.bitmap&&console.log("[PrintViewWidget.WORKER1] bitmap received",t.data.bitmap);break}}})();
